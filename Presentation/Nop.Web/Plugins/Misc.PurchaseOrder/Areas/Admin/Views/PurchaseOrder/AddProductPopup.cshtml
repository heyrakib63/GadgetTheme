@model AddProductPopupModel

@{
	Layout = "_AdminPopupLayout";
}

<section class="content">
	<div class="container-fluid">
		<div class="card card-default">
			<div class="card-header">
				<h3 class="card-title">Select Products for Supplier</h3>
			</div>
			<div class="card-body">
				<form id="product-selection-form" onsubmit="return false;">
					<table class="table table-bordered table-striped">
						<thead>
							<tr>
								<th>Select</th>
								<th>Product</th>
								<th>Unit Price</th>
								<th>Quantity</th>
								<th>Total Cost</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var product in Model.Products)
							{
								<tr>
									<td>
										<input type="checkbox" class="product-checkbox"
											   data-productid="@product.ProductId" />
									</td>
									<td>@product.ProductName</td>
									<td>
										<input type="number" class="unit-price form-control form-control-sm"
											   value="@product.UnitPrice" />
									</td>
									<td>
										<input type="number" class="quantity form-control form-control-sm"
											   value="@product.Quantity" />
									</td>
									<td class="total-cost text-right">@product.TotalCost.ToString("0.00")</td>
								</tr>
							}
						</tbody>
					</table>

					<div class="text-center mt-3">
						<button type="button" id="save-selected-products"
								class="btn btn-primary">
							<i class="fas fa-save"></i> Save Selected Products
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</section>
<script>
	$(function () {
		$('#save-selected-products').click(function () {
			var selectedProducts = [];

			$('.product-checkbox:checked').each(function () {
				var row = $(this).closest('tr');
				var productId = $(this).data('productid');
				var productName = row.find('td').eq(1).text();
				var unitPrice = parseFloat(row.find('.unit-price').val());
				var quantity = parseInt(row.find('.quantity').val(), 10);

				selectedProducts.push({
					ProductId: productId,
					ProductName: productName,
					UnitPrice: unitPrice,
					Quantity: quantity,
					TotalCost: unitPrice * quantity
				});
			});

			if (selectedProducts.length === 0) {
				alert("Please select at least one product.");
				return;
			}

			$.ajax({
				type: "POST",
				url: "/Admin/PurchaseOrder/AddSelectedProducts",
				data: JSON.stringify(selectedProducts),
				contentType: "application/json; charset=utf-8",
				success: function () {
					if (window.opener && typeof window.opener.refreshSelectedProductsGrid === "function") {
						window.opener.refreshSelectedProductsGrid();
					}
					window.close();
				},
				error: function (xhr, status, error) {
					alert("Failed to add products: " + error);
				}
			});
		});
	});
</script>
